<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>案件清單明細</title>
<link rel="stylesheet" href="/css/Review.css" />
</head>
<body>
	<form id="addForm" action="/CreateJob" method="get">
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="applno-label">收件編號</span> <input
						type="text" class="form-control" id="applno" name="applno"
						aria-describedby="applno-label" readonly>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuName-label">中文姓名</span> <input
						type="text" class="form-control" id="cuName" name="cuName"
						aria-describedby="cuName-label">
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuId-label">身分證字號</span> <input
						type="text" class="form-control" id="cuId" name="cuId"
						aria-describedby="cuId-label">
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuName">生日</span> <input
						type="date" class="form-control" id="cuBirthday" name="cuBirthday" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuName">帳單地址</span>
					<select id="citySelect1" name="city" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
					</select> <select id="districtSelect1" name="district" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
					</select> <input type="text" id="cuBillAddr" name="cuBillAddr"
						class="form-control" placeholder="請輸入"
						style="flex: 0 0 70%; max-width: 70%;" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="applno-label">住宅電話</span> <input
						type="text" class="form-control" id="cuHTel" name="cuHTel" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuCpTel-label">公司電話</span> <input
						type="text" id="cuCpTel" name="cuCpTel" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuMTel-label">行動電話</span> <input
						type="text" id="cuMTel" name="cuMTel" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuEmail-label">@</span> <input
						type="email" id="cuEmail" name="cuEmail" class="form-control" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuCpName-label">公司名稱</span> <input
						type="text" id="cuCpName" name="cuCpName" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cardFlag-label">卡片 flag</span> <select
						id="cardFlag" name="cardFlag" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${cardFlagDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="fraudType-label">詐欺類型</span> <select
						id="fraudType" name="fraudType" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${fraudTypeDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cardType-label">卡別</span> <select
						id="cardType" name="cardType" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${cardTypeDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="agreeChange-label">是否同意改發</span>
					<select id="agreeChange" name="agreeChange" class="form-select">
						<option value="">請選擇</option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="agreePrint-label">是否列印通知函</span>
					<select id="agreePrint" name="agreePrint" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${yNDtoList}" th:value="${item.codeNo}"
							th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuSendCode">通知函寄送地址</span>
					<select id="citySelect2" name="city" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
					</select>
					<select id="districtSelect2" name="district" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
					</select>
					<input type="text" id="cuSendCode" name="cuSendCode"
						class="form-control" placeholder="請輸入"
						style="flex: 0 0 65%; max-width: 65%;" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuBillDate-label">帳單結帳日：</span>
					<input type="date" class="form-control" id="cuBillDate"
						name="cuBillDate" aria-describedby="cuBillDate-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="loanCount-label">授款筆數：</span> <input
						type="text" class="form-control" id="loanCount" name="loanCount"
						aria-describedby="loanCount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="loanAmount-label">授款金額：</span> <input
						type="text" class="form-control" id="loanAmount" name="loanAmount"
						aria-describedby="loanAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="claimCount-label">請款筆數：</span> <input
						type="text" class="form-control" id="claimCount" name="claimCount"
						aria-describedby="claimCount-label" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="claimAmount-label">請款金額：</span>
					<input type="text" class="form-control" id="claimAmount"
						name="claimAmount" aria-describedby="claimAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cbSuccessAmount-label">CB成功金額：</span>
					<input type="text" class="form-control" id="cbSuccessAmount"
						name="cbSuccessAmount" aria-describedby="cbSuccessAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="customerPayAmount-label">客戶承擔金額：</span>
					<input type="text" class="form-control" id="customerPayAmount"
						name="customerPayAmount"
						aria-describedby="customerPayAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="bankPayAmount-label">本行承擔金額：</span>
					<input type="text" class="form-control" id="bankPayAmount"
						name="bankPayAmount" aria-describedby="bankPayAmount-label" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="fscComplaint-label">金管會申訴：</span>
					<input type="text" class="form-control" id="fscComplaint"
						name="fscComplaint" aria-describedby="fscComplaint-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="finDispute-label">金融評議中心申訴：</span>
					<input type="text" class="form-control" id="finDispute"
						name="finDispute" aria-describedby="finDispute-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="judicialAgency-label">司法機關來函查詢-機關名稱：</span>
					<input type="text" class="form-control" id="judicialAgency"
						name="judicialAgency" aria-describedby="judicialAgency-label" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="fscDisputeDate-label">金管會申訴日期：</span>
					<input type="date" class="form-control" id="fscDisputeDate"
						name="fscDisputeDate" aria-describedby="fscDisputeDate-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="finDisputeDate-label">金融評議中心申訴日期：</span>
					<input type="date" class="form-control" id="finDisputeDate"
						name="finDisputeDate" aria-describedby="finDisputeDate-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="judicialDate-label">司法機關來函查詢日期：</span>
					<input type="date" class="form-control" id="judicialDate"
						name="judicialDate" aria-describedby="judicialDate-label" />
				</div>
			</div>
		</div>

		<div class="row mb-3">
			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="suspectName-label">嫌犯姓名：</span>
					<input type="text" class="form-control" id="suspectName"
						name="suspectName" aria-describedby="suspectName-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="suspectId-label">嫌犯ID：</span> <input
						type="text" class="form-control" id="suspectId" name="suspectId"
						aria-describedby="suspectId-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="fraudFeature-label">盜刷特徵：</span>
					<input type="text" class="form-control" id="fraudFeature"
						name="fraudFeature" aria-describedby="fraudFeature-label" />
				</div>
			</div>
		</div>

	</form>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
	
	$(document).ready(function () {
	    // 取得 URL 參數
	    const urlParams = new URLSearchParams(window.location.search);
	    const para1 = urlParams.get('para1') || '';
	    const codeType = urlParams.get('codeType') || '';
	    const applno = urlParams.get('applno');

	    // 設定 applno 至 input 欄位
	    const applnoInput = document.getElementById('applno');
	    if (applnoInput && applno !== null) {
	        applnoInput.value = applno;
	    } else {
	        console.warn('找不到 applno 輸入框或 URL 沒帶 applno');
	    }

	    // 載入初始資料
	    function loadCreateJobData() {
	        $.ajax({
	            url: '/CreateJobJson',
	            type: 'GET',
	            data: { para1, codeType },
	            dataType: 'json',
	            success: function (data) {
	                console.log('取得資料', data);

	                // 城市帶入，並帶上 data-zip-no 屬性
	                renderSelect('#citySelect1', data.cityDtoList);
	                resetDistrictSelect('#districtSelect1', data.districtDtoList);
	                
	                renderSelect('#citySelect2', data.cityDtoList);
	                resetDistrictSelect('#districtSelect2', data.districtDtoList);

	             	// 🔄 修改這裡：改為 HTML 實際的 select ID
	                renderSelectGeneric('#cardFlag', data.cardFlagDtoList, 'codeNo', 'codeDesc');
	                renderSelectGeneric('#fraudType', data.fraudTypeDtoList, 'codeNo', 'codeDesc');
	                renderSelectGeneric('#cardType', data.cardTypeDtoList, 'codeNo', 'codeDesc');

	                // 是否 Y/N 選單
	                renderSelectGeneric('#ynSelect', data.yNDtoList, 'codeNo', 'codeDesc');
					renderSelectGeneric('#agreeChange', data.yNDtoList, 'codeNo', 'codeDesc');
					renderSelectGeneric('#agreePrint', data.yNDtoList, 'codeNo', 'codeDesc');


	                // 假設有需要把 cfBatchParaDto 裡的值帶入欄位
	                if (data.cfBatchParaDto && data.cfBatchParaDto.batchName) {
	                    $('#batchNameField').val(data.cfBatchParaDto.batchName);
	                }
	            },
	            error: function (xhr, status, error) {
	                alert('資料載入失敗！');
	                console.error(error);
	            }
	        });
	    }

	    // 渲染城市專用，會帶 data-zip-no
	    function renderSelect(selector, list) {
	        const $select = $(selector);
	        $select.empty();
	        $select.append('<option value="">請選擇</option>');

	        if (!list || list.length === 0) {
	            $select.append('<option value="">-- 無資料 --</option>');
	            return;
	        }

	        list.forEach(item => {
	            $select.append(
	                `<option value="${item.fkNo}" data-zip-no="${item.zipNo}">${item.zipName}</option>`
	            );
	        });
	    }

	    // 渲染一般 select，給定 valueKey 和 textKey
	    function renderSelectGeneric(selector, list, valueKey, textKey) {
	        const $select = $(selector);
	        $select.empty();
	        $select.append('<option value="">請選擇</option>');

	        if (!list || list.length === 0) {
	            $select.append('<option value="">-- 無資料 --</option>');
	            return;
	        }

	        list.forEach(item => {
	            $select.append(
	                `<option value="${item[valueKey]}">${item[textKey]}</option>`
	            );
	        });
	    }

	    // 清空區域下拉選單並加入預設選項
	    function resetDistrictSelect(selector) {
	        const $select = $(selector);
	        $select.empty();
	        $select.append('<option value="">請選擇</option>');
	    }

	    // 綁定城市變更事件，自動帶出對應區域
	    function bindCityChange(citySelectId, districtSelectId) {
	        $('#' + citySelectId).change(function () {
	            const selectedZipNo = $(this).find('option:selected').data('zip-no');
	            console.log('選擇的 zipNo:', selectedZipNo);

	            if (!selectedZipNo) {
	                resetDistrictSelect('#' + districtSelectId);
	                return;
	            }

	            // 請求後端取得該 zipNo 的區域資料
	            $.ajax({
	                url: '/getDistricts',
	                type: 'GET',
	                data: { zipNo: selectedZipNo },
	                dataType: 'json',
	                success: function (districts) {
	                    const $districtSelect = $('#' + districtSelectId);
	                    $districtSelect.empty();
	                    $districtSelect.append('<option value="">請選擇</option>');

	                    if (Array.isArray(districts) && districts.length > 0) {
	                        districts.forEach(district => {
	                            if (district.fkNo && district.zipName) {
	                                $districtSelect.append(
	                                    $('<option>')
	                                        .val(district.fkNo)
	                                        .text(district.zipName)
	                                        .attr('data-zip-no', district.zipNo || '') // 若需要，也可以帶上 data-zip-no
	                                );
	                            }
	                        });
	                    } else {
	                        alert('該縣市無區域資料');
	                    }
	                },
	                error: function () {
	                    alert('無法取得區域資料，請稍後再試');
	                    resetDistrictSelect('#' + districtSelectId);
	                }
	            });
	        });
	    }

	    // 初始化載入與事件綁定
	    loadCreateJobData();
	    bindCityChange('citySelect1', 'districtSelect1');
	    bindCityChange('citySelect2', 'districtSelect2');
	    // 如果你還有第二組城市區域選單，就解除以下註解
	});

    
    // 新增表單
function saveFormData() {
    const fields = [
    	'applno', 'cuName', 'cuId', 'cuBirthday', 'cuBillAddr',
        'citySelect1', 'districtSelect1', 'cuHTel', 'cuCpTel', 'cuMTel',
        'cuEmail', 'cuCpName', 'cardFlag', 'fraudType', 'cardType',
        'agreeChange', 'agreePrint', 'cuSendCode', 'citySelect2', 'districtSelect2'
    ];

    const formData = {};

    fields.forEach(field => {
        const el = document.getElementById(field);
        if (el) {
            let val = el.value?.trim() ?? null;
            // 🔧 特別處理 cuBirthday 格式（yyyy-MM-dd → yyyyMMdd）
            if (field === 'cuBirthday' && val) {
                val = val.replace(/-/g, '');  // 移除 "-"
                if (val.length !== 8) {
                    alert('生日格式錯誤，請輸入正確日期');
                    return;
                }
            }
            formData[field] = val;
        } else {
            formData[field] = null;
            console.warn(`找不到欄位: ${field}`);
        }
    });

    console.log('✅ 最終送出資料:', formData);

   $.ajax({
        url: '/CreateJob/save',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
            alert(response);
        },
        error: function (xhr) {
            alert('儲存失敗: ' + xhr.responseText);
        }
    });
}
</script>
</body>
</html>