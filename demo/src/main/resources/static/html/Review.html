<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>æ¡ˆä»¶æ¸…å–®æ˜ç´°</title>
<link rel="stylesheet" href="/css/Review.css" />
</head>
<body>
	<form id="addForm" action="/CreateJob" method="get">
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="applno-label">æ”¶ä»¶ç·¨è™Ÿ</span> <input
						type="text" class="form-control" id="applno" name="applno"
						aria-describedby="applno-label" readonly>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuName-label">ä¸­æ–‡å§“å</span> <input
						type="text" class="form-control" id="cuName" name="cuName"
						aria-describedby="cuName-label">
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuId-label">èº«åˆ†è­‰å­—è™Ÿ</span> <input
						type="text" class="form-control" id="cuId" name="cuId"
						aria-describedby="cuId-label">
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuName">ç”Ÿæ—¥</span> <input
						type="date" class="form-control" id="cuBirthday" name="cuBirthday" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuName">å¸³å–®åœ°å€</span>
					<select id="citySelect1" name="city" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">è«‹é¸æ“‡</option>
					</select> <select id="districtSelect1" name="district" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">è«‹é¸æ“‡</option>
					</select> <input type="text" id="cuBillAddr" name="cuBillAddr"
						class="form-control" placeholder="è«‹è¼¸å…¥"
						style="flex: 0 0 70%; max-width: 70%;" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="applno-label">ä½å®…é›»è©±</span> <input
						type="text" class="form-control" id="cuHTel" name="cuHTel" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuCpTel-label">å…¬å¸é›»è©±</span> <input
						type="text" id="cuCpTel" name="cuCpTel" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuMTel-label">è¡Œå‹•é›»è©±</span> <input
						type="text" id="cuMTel" name="cuMTel" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuEmail-label">@</span> <input
						type="email" id="cuEmail" name="cuEmail" class="form-control" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuCpName-label">å…¬å¸åç¨±</span> <input
						type="text" id="cuCpName" name="cuCpName" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cardFlag-label">å¡ç‰‡ flag</span> <select
						id="cardFlag" name="cardFlag" class="form-select">
						<option value="">è«‹é¸æ“‡</option>
						<option th:each="item : ${cardFlagDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="fraudType-label">è©æ¬ºé¡å‹</span> <select
						id="fraudType" name="fraudType" class="form-select">
						<option value="">è«‹é¸æ“‡</option>
						<option th:each="item : ${fraudTypeDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cardType-label">å¡åˆ¥</span> <select
						id="cardType" name="cardType" class="form-select">
						<option value="">è«‹é¸æ“‡</option>
						<option th:each="item : ${cardTypeDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="agreeChange-label">æ˜¯å¦åŒæ„æ”¹ç™¼</span>
					<select id="agreeChange" name="agreeChange" class="form-select">
						<option value="">è«‹é¸æ“‡</option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="agreePrint-label">æ˜¯å¦åˆ—å°é€šçŸ¥å‡½</span>
					<select id="agreePrint" name="agreePrint" class="form-select">
						<option value="">è«‹é¸æ“‡</option>
						<option th:each="item : ${yNDtoList}" th:value="${item.codeNo}"
							th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuSendCode">é€šçŸ¥å‡½å¯„é€åœ°å€</span>
					<select id="citySelect2" name="city" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">è«‹é¸æ“‡</option>
					</select>
					<select id="districtSelect2" name="district" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">è«‹é¸æ“‡</option>
					</select>
					<input type="text" id="cuSendCode" name="cuSendCode"
						class="form-control" placeholder="è«‹è¼¸å…¥"
						style="flex: 0 0 65%; max-width: 65%;" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuBillDate-label">å¸³å–®çµå¸³æ—¥ï¼š</span>
					<input type="date" class="form-control" id="cuBillDate"
						name="cuBillDate" aria-describedby="cuBillDate-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="loanCount-label">æˆæ¬¾ç­†æ•¸ï¼š</span> <input
						type="text" class="form-control" id="loanCount" name="loanCount"
						aria-describedby="loanCount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="loanAmount-label">æˆæ¬¾é‡‘é¡ï¼š</span> <input
						type="text" class="form-control" id="loanAmount" name="loanAmount"
						aria-describedby="loanAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="claimCount-label">è«‹æ¬¾ç­†æ•¸ï¼š</span> <input
						type="text" class="form-control" id="claimCount" name="claimCount"
						aria-describedby="claimCount-label" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="claimAmount-label">è«‹æ¬¾é‡‘é¡ï¼š</span>
					<input type="text" class="form-control" id="claimAmount"
						name="claimAmount" aria-describedby="claimAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cbSuccessAmount-label">CBæˆåŠŸé‡‘é¡ï¼š</span>
					<input type="text" class="form-control" id="cbSuccessAmount"
						name="cbSuccessAmount" aria-describedby="cbSuccessAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="customerPayAmount-label">å®¢æˆ¶æ‰¿æ“”é‡‘é¡ï¼š</span>
					<input type="text" class="form-control" id="customerPayAmount"
						name="customerPayAmount"
						aria-describedby="customerPayAmount-label" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="bankPayAmount-label">æœ¬è¡Œæ‰¿æ“”é‡‘é¡ï¼š</span>
					<input type="text" class="form-control" id="bankPayAmount"
						name="bankPayAmount" aria-describedby="bankPayAmount-label" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="fscComplaint-label">é‡‘ç®¡æœƒç”³è¨´ï¼š</span>
					<input type="text" class="form-control" id="fscComplaint"
						name="fscComplaint" aria-describedby="fscComplaint-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="finDispute-label">é‡‘èè©•è­°ä¸­å¿ƒç”³è¨´ï¼š</span>
					<input type="text" class="form-control" id="finDispute"
						name="finDispute" aria-describedby="finDispute-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="judicialAgency-label">å¸æ³•æ©Ÿé—œä¾†å‡½æŸ¥è©¢-æ©Ÿé—œåç¨±ï¼š</span>
					<input type="text" class="form-control" id="judicialAgency"
						name="judicialAgency" aria-describedby="judicialAgency-label" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="fscDisputeDate-label">é‡‘ç®¡æœƒç”³è¨´æ—¥æœŸï¼š</span>
					<input type="date" class="form-control" id="fscDisputeDate"
						name="fscDisputeDate" aria-describedby="fscDisputeDate-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="finDisputeDate-label">é‡‘èè©•è­°ä¸­å¿ƒç”³è¨´æ—¥æœŸï¼š</span>
					<input type="date" class="form-control" id="finDisputeDate"
						name="finDisputeDate" aria-describedby="finDisputeDate-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="judicialDate-label">å¸æ³•æ©Ÿé—œä¾†å‡½æŸ¥è©¢æ—¥æœŸï¼š</span>
					<input type="date" class="form-control" id="judicialDate"
						name="judicialDate" aria-describedby="judicialDate-label" />
				</div>
			</div>
		</div>

		<div class="row mb-3">
			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="suspectName-label">å«ŒçŠ¯å§“åï¼š</span>
					<input type="text" class="form-control" id="suspectName"
						name="suspectName" aria-describedby="suspectName-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="suspectId-label">å«ŒçŠ¯IDï¼š</span> <input
						type="text" class="form-control" id="suspectId" name="suspectId"
						aria-describedby="suspectId-label" />
				</div>
			</div>

			<div class="col-md-4">
				<div class="input-group">
					<span class="input-group-text" id="fraudFeature-label">ç›œåˆ·ç‰¹å¾µï¼š</span>
					<input type="text" class="form-control" id="fraudFeature"
						name="fraudFeature" aria-describedby="fraudFeature-label" />
				</div>
			</div>
		</div>

	</form>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
	
	$(document).ready(function () {
	    // å–å¾— URL åƒæ•¸
	    const urlParams = new URLSearchParams(window.location.search);
	    const para1 = urlParams.get('para1') || '';
	    const codeType = urlParams.get('codeType') || '';
	    const applno = urlParams.get('applno');

	    // è¨­å®š applno è‡³ input æ¬„ä½
	    const applnoInput = document.getElementById('applno');
	    if (applnoInput && applno !== null) {
	        applnoInput.value = applno;
	    } else {
	        console.warn('æ‰¾ä¸åˆ° applno è¼¸å…¥æ¡†æˆ– URL æ²’å¸¶ applno');
	    }

	    // è¼‰å…¥åˆå§‹è³‡æ–™
	    function loadCreateJobData() {
	        $.ajax({
	            url: '/CreateJobJson',
	            type: 'GET',
	            data: { para1, codeType },
	            dataType: 'json',
	            success: function (data) {
	                console.log('å–å¾—è³‡æ–™', data);

	                // åŸå¸‚å¸¶å…¥ï¼Œä¸¦å¸¶ä¸Š data-zip-no å±¬æ€§
	                renderSelect('#citySelect1', data.cityDtoList);
	                resetDistrictSelect('#districtSelect1', data.districtDtoList);
	                
	                renderSelect('#citySelect2', data.cityDtoList);
	                resetDistrictSelect('#districtSelect2', data.districtDtoList);

	             	// ğŸ”„ ä¿®æ”¹é€™è£¡ï¼šæ”¹ç‚º HTML å¯¦éš›çš„ select ID
	                renderSelectGeneric('#cardFlag', data.cardFlagDtoList, 'codeNo', 'codeDesc');
	                renderSelectGeneric('#fraudType', data.fraudTypeDtoList, 'codeNo', 'codeDesc');
	                renderSelectGeneric('#cardType', data.cardTypeDtoList, 'codeNo', 'codeDesc');

	                // æ˜¯å¦ Y/N é¸å–®
	                renderSelectGeneric('#ynSelect', data.yNDtoList, 'codeNo', 'codeDesc');
					renderSelectGeneric('#agreeChange', data.yNDtoList, 'codeNo', 'codeDesc');
					renderSelectGeneric('#agreePrint', data.yNDtoList, 'codeNo', 'codeDesc');


	                // å‡è¨­æœ‰éœ€è¦æŠŠ cfBatchParaDto è£¡çš„å€¼å¸¶å…¥æ¬„ä½
	                if (data.cfBatchParaDto && data.cfBatchParaDto.batchName) {
	                    $('#batchNameField').val(data.cfBatchParaDto.batchName);
	                }
	            },
	            error: function (xhr, status, error) {
	                alert('è³‡æ–™è¼‰å…¥å¤±æ•—ï¼');
	                console.error(error);
	            }
	        });
	    }

	    // æ¸²æŸ“åŸå¸‚å°ˆç”¨ï¼Œæœƒå¸¶ data-zip-no
	    function renderSelect(selector, list) {
	        const $select = $(selector);
	        $select.empty();
	        $select.append('<option value="">è«‹é¸æ“‡</option>');

	        if (!list || list.length === 0) {
	            $select.append('<option value="">-- ç„¡è³‡æ–™ --</option>');
	            return;
	        }

	        list.forEach(item => {
	            $select.append(
	                `<option value="${item.fkNo}" data-zip-no="${item.zipNo}">${item.zipName}</option>`
	            );
	        });
	    }

	    // æ¸²æŸ“ä¸€èˆ¬ selectï¼Œçµ¦å®š valueKey å’Œ textKey
	    function renderSelectGeneric(selector, list, valueKey, textKey) {
	        const $select = $(selector);
	        $select.empty();
	        $select.append('<option value="">è«‹é¸æ“‡</option>');

	        if (!list || list.length === 0) {
	            $select.append('<option value="">-- ç„¡è³‡æ–™ --</option>');
	            return;
	        }

	        list.forEach(item => {
	            $select.append(
	                `<option value="${item[valueKey]}">${item[textKey]}</option>`
	            );
	        });
	    }

	    // æ¸…ç©ºå€åŸŸä¸‹æ‹‰é¸å–®ä¸¦åŠ å…¥é è¨­é¸é …
	    function resetDistrictSelect(selector) {
	        const $select = $(selector);
	        $select.empty();
	        $select.append('<option value="">è«‹é¸æ“‡</option>');
	    }

	    // ç¶å®šåŸå¸‚è®Šæ›´äº‹ä»¶ï¼Œè‡ªå‹•å¸¶å‡ºå°æ‡‰å€åŸŸ
	    function bindCityChange(citySelectId, districtSelectId) {
	        $('#' + citySelectId).change(function () {
	            const selectedZipNo = $(this).find('option:selected').data('zip-no');
	            console.log('é¸æ“‡çš„ zipNo:', selectedZipNo);

	            if (!selectedZipNo) {
	                resetDistrictSelect('#' + districtSelectId);
	                return;
	            }

	            // è«‹æ±‚å¾Œç«¯å–å¾—è©² zipNo çš„å€åŸŸè³‡æ–™
	            $.ajax({
	                url: '/getDistricts',
	                type: 'GET',
	                data: { zipNo: selectedZipNo },
	                dataType: 'json',
	                success: function (districts) {
	                    const $districtSelect = $('#' + districtSelectId);
	                    $districtSelect.empty();
	                    $districtSelect.append('<option value="">è«‹é¸æ“‡</option>');

	                    if (Array.isArray(districts) && districts.length > 0) {
	                        districts.forEach(district => {
	                            if (district.fkNo && district.zipName) {
	                                $districtSelect.append(
	                                    $('<option>')
	                                        .val(district.fkNo)
	                                        .text(district.zipName)
	                                        .attr('data-zip-no', district.zipNo || '') // è‹¥éœ€è¦ï¼Œä¹Ÿå¯ä»¥å¸¶ä¸Š data-zip-no
	                                );
	                            }
	                        });
	                    } else {
	                        alert('è©²ç¸£å¸‚ç„¡å€åŸŸè³‡æ–™');
	                    }
	                },
	                error: function () {
	                    alert('ç„¡æ³•å–å¾—å€åŸŸè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦');
	                    resetDistrictSelect('#' + districtSelectId);
	                }
	            });
	        });
	    }

	    // åˆå§‹åŒ–è¼‰å…¥èˆ‡äº‹ä»¶ç¶å®š
	    loadCreateJobData();
	    bindCityChange('citySelect1', 'districtSelect1');
	    bindCityChange('citySelect2', 'districtSelect2');
	    // å¦‚æœä½ é‚„æœ‰ç¬¬äºŒçµ„åŸå¸‚å€åŸŸé¸å–®ï¼Œå°±è§£é™¤ä»¥ä¸‹è¨»è§£
	});

    
    // æ–°å¢è¡¨å–®
function saveFormData() {
    const fields = [
    	'applno', 'cuName', 'cuId', 'cuBirthday', 'cuBillAddr',
        'citySelect1', 'districtSelect1', 'cuHTel', 'cuCpTel', 'cuMTel',
        'cuEmail', 'cuCpName', 'cardFlag', 'fraudType', 'cardType',
        'agreeChange', 'agreePrint', 'cuSendCode', 'citySelect2', 'districtSelect2'
    ];

    const formData = {};

    fields.forEach(field => {
        const el = document.getElementById(field);
        if (el) {
            let val = el.value?.trim() ?? null;
            // ğŸ”§ ç‰¹åˆ¥è™•ç† cuBirthday æ ¼å¼ï¼ˆyyyy-MM-dd â†’ yyyyMMddï¼‰
            if (field === 'cuBirthday' && val) {
                val = val.replace(/-/g, '');  // ç§»é™¤ "-"
                if (val.length !== 8) {
                    alert('ç”Ÿæ—¥æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ­£ç¢ºæ—¥æœŸ');
                    return;
                }
            }
            formData[field] = val;
        } else {
            formData[field] = null;
            console.warn(`æ‰¾ä¸åˆ°æ¬„ä½: ${field}`);
        }
    });

    console.log('âœ… æœ€çµ‚é€å‡ºè³‡æ–™:', formData);

   $.ajax({
        url: '/CreateJob/save',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
            alert(response);
        },
        error: function (xhr) {
            alert('å„²å­˜å¤±æ•—: ' + xhr.responseText);
        }
    });
}
</script>
</body>
</html>