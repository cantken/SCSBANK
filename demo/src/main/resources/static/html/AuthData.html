<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>æˆæ¬Šè³‡æ–™</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" href="/css/AuthData.css" />
</head>
<body>
	<div class="button-container"></div>
	<!-- ğŸ”½ æŸ¥è©¢è¼¸å…¥å€å¡Š -->
	<form id="authDataForm" action="javascript:void(0)" method="get">
		<div class="container-fluid mb-3">
			<div class="row g-3 align-items-end">
				<!-- é€²ä»¶æ—¥æœŸ -->
				<div class="col-md-4">
					<label for="caseInputStartDate" class="form-label">é€²ä»¶æ—¥æœŸï¼š</label>
					<div class="input-group">
						<input type="date" id="caseInputStartDate"
							name="caseInputStartDate" class="form-control"> <span
							class="input-group-text">~</span> <input type="date"
							id="caseInputEndDate" name="caseInputEndDate"
							class="form-control">
					</div>
				</div>
				<!-- æŒ‰éˆ•å€å¡Š -->
				<div class="col-md-4 d-flex gap-2">
					<input type="hidden" id="applno" name="applno">
					<button type="button" class="btn btn-primary"
						onclick="loadAuthData()">æŸ¥è©¢</button>
					<button type="button" class="btn btn-secondary"
						onclick="handleButtonClick('deleteData')">æ¸…ç©º</button>
				</div>
				<button class="btn btn-primary" onclick="updateAuthData()">å„²å­˜è³‡æ–™</button>

			</div>
		</div>
		<br> <br>
		<table id="caseListTable"
			class="table table-hover align-middle text-center">
			<thead class="table-light">
				<tr>
					<th class="hidden-column">æ”¶ä»¶ç·¨è™Ÿ</th>
					<th scope="col">é»é¸</th>
					<th scope="col">äº¤æ˜“æ—¥æœŸ</th>
					<th scope="col">äº¤æ˜“æ™‚é–“</th>
					<th scope="col">æ”¶å–®éŠ€è¡Œ</th>
					<th scope="col">å•†åº—ä»£è™Ÿ</th>
					<th scope="col">MCC</th>
					<th scope="col">äº¤æ˜“åœ‹åˆ¥</th>
					<th scope="col">äº¤æ˜“é‡‘é¡</th>
					<th scope="col">æˆæ¬Šç¢¼</th>
					<th scope="col">EM</th>
					<th scope="col">å¾®ç¸®å½±ç·¨è™Ÿ</th>
				</tr>
			</thead>
			<tbody>
				<!-- JavaScript å‹•æ…‹æ¸²æŸ“ -->
			</tbody>
		</table>
	</form>
	<!-- jQuery & Bootstrap Bundle -->
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

	<script>
	function loadAuthData() {
		  const applno = $('#authApplno').val();
		  const tradeDate = $('#authTradeDate').val();

		  $.ajax({
		    url: '/AuthDataJson',
		    method: 'GET',
		    data: {
		      applno: applno,
		      tradeDate: tradeDate
		    },
		    success: function(res) {
		      const tbody = $('#caseListTable tbody');  // é€™è£¡æ”¹æˆæ­£ç¢ºçš„table id
		      tbody.empty();

		      if (res.dtoList && res.dtoList.length > 0) {
		        res.dtoList.forEach(item => {
		        	const row = `
		        		<tr>
		        		<td class="applno" style="display:none;">${item.applNo}</td>
		        		  <td class="uuid" style="display:none;">
		        		    <input type="hidden" class="uuid" value="${item.uuid || ''}" />
		        		  </td>
		        	    <td class="choice">
		        	      <div class="form-check d-flex justify-content-center">
		        	      <input class="form-check-input choice-checkbox" type="checkbox"
		        	          ${item.choice == '1' ? 'checked' : ''} />
		        	      </div>
		        	    </td>
		        		  <td class="tradeDateStr">${item.tradeDateStr || ''}</td>
		        		  <td class="tradrTime">${item.tradrTime || ''}</td>
		        		  <td class="acBank">${item.acBank || ''}</td>
		        		  <td class="shopCode">${item.shopCode || ''}</td>
		        		  <td class="mcc">${item.mcc || ''}</td>
		        		  <td class="tradeCountry">${item.tradeCountry || ''}</td>
		        		  <td class="tradeMoney">${item.tradeMoney || ''}</td>
		        		  <td class="authCode">${item.authCode || ''}</td>
		        		  <td class="em">${item.em || ''}</td>
		        		  <td class="mfCode">${item.mfCode || ''}</td>
		        		</tr>`;
		          tbody.append(row);
		        });
		      } else {
		        tbody.append('<tr><td colspan="12" class="text-center">æŸ¥ç„¡è³‡æ–™</td></tr>');
		      }
		    },
		    error: function() {
		      alert('è³‡æ–™è®€å–å¤±æ•—');
		    }
		  });
		}

	function clearAuthForm() {
		$('#authApplno').val('');
	}
	
	// æ›´æ–°
	function updateAuthData() {
  const applno = $("#authApplno").val()?.trim() || '';
  const rows = document.querySelectorAll("#caseListTable tbody tr");
  const dtoList = [];

  rows.forEach(row => {
    const checkbox = row.querySelector(".choice-checkbox");

    // æ”¹é€™è£¡ âœ… ä¿éšªå¯«æ³•ï¼šå…ˆæŠ“ï¼Œå†æª¢æŸ¥
    let uuidInput = row.querySelector("input.uuid");
    let uuidValue = '';
    if (uuidInput && uuidInput.value) {
      uuidValue = uuidInput.value.trim();
    }

    const dto = {
      applno: applno,
      choice: checkbox?.checked ? '1' : '0',
      tradeDateStr: row.querySelector(".tradeDateStr")?.textContent?.trim() || '',
      tradrTime: row.querySelector(".tradrTime")?.textContent?.trim() || '',
      acBank: row.querySelector(".acBank")?.textContent?.trim() || '',
      shopCode: row.querySelector(".shopCode")?.textContent?.trim() || '',
      mcc: row.querySelector(".mcc")?.textContent?.trim() || '',
      tradeCountry: row.querySelector(".tradeCountry")?.textContent?.trim() || '',
      tradeMoney: row.querySelector(".tradeMoney")?.textContent?.trim() || '',
      authCode: row.querySelector(".authCode")?.textContent?.trim() || '',
      em: row.querySelector(".em")?.textContent?.trim() || '',
      mfCode: row.querySelector(".mfCode")?.textContent?.trim() || '',
      uuid: uuidValue
    };

    dtoList.push(dto);
  });

  const requestData = {
    applno: applno,
    dtoList: dtoList
  };

  console.log("âœ… é€å‡ºçš„è³‡æ–™ï¼š", requestData);

  $.ajax({
    url: '/AuthDataJson/update',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(requestData),
    success: function (res) {
      alert('æ›´æ–°æˆåŠŸ');
    },
    error: function (xhr) {
      console.error('æ›´æ–°å¤±æ•—ï¼š', xhr);
      alert('æ›´æ–°å¤±æ•—ï¼š' + xhr.status + '\n' + xhr.responseText);
    }
  });
}

</script>


</body>
</html>