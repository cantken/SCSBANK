<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>çµ„ç¹”äººå“¡ç¶­è­·</title>
<link rel="stylesheet" th:href="@{/css/EmployeeSet.css}" />
<!-- Bootstrap 5 CSS -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<!-- Bootstrap 5 JS -->
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body>
	<div class="button-container">
		<form th:action="@{/EmployeeSet/query}" method="get"
			style="display: inline">
			<input type="text" name="empNo" placeholder="è«‹è¼¸å…¥å“¡å·¥ç·¨è™Ÿ">
			<button id="queryBtn" type="submit">æŸ¥è©¢</button>
		</form>
		<button id="addBtn" type="button" onclick="handleButtonClick('add')">æ–°å¢</button>
		<button id="queryDataBtn" type="button"
			onclick="handleButtonClick('queryData')">æŸ¥è©¢è³‡æ–™</button>
		<button id="saveDataBtn" type="button"
			onclick="handleButtonClick('saveData')">å„²å­˜è³‡æ–™</button>
	</div>

	<!-- ğŸ”½ æ–°å¢è¼¸å…¥å€å¡Š -->
	<div id="addFormSection" style="display: none; margin-top: 20px;">
		<form id="addForm" action="/EmployeeSet/save" method="post">
			<table>
				<tbody>
					<tr>
						<td><label for="empNo">å“¡å·¥ç·¨è™Ÿï¼š</label></td>
						<td><input type="text" id="empNo" name="empNo" readonly
							pattern="^\d{1,5}$" maxlength="5" title="è«‹è¼¸å…¥æœ€å¤š5ä½æ•¸å­—" required
							oninput="checkEmpNo(this)"> <span id="empNoError"
							style="color: red; display: none;">è«‹è¼¸å…¥æœ€å¤š5ä½æ•¸å­—</span></td>
						<td><input type="text" id="empName" name="empName"
							pattern="^[\u4e00-\u9fa5]{1,4}$" maxlength="4" title="è«‹è¼¸å…¥1è‡³4å€‹ä¸­æ–‡å­—"
							required oninput="checkEmpName(this)"> <span
							id="empNameError" style="color: red; display: none;">è«‹è¼¸å…¥1è‡³4å€‹ä¸­æ–‡å­—</span>
						</td>
					</tr>
					<tr>
						<td><label for="onJob">æ˜¯å¦åœ¨è·ï¼š</label></td>
						<td><select id="onJob" name="onJob">
								<option value="" disabled selected class="placeholder">è«‹é¸æ“‡</option>
								<th:block th:if="${codeYnDropList != null}"
									th:each="item : ${codeYnDropList}">
									<option th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
								</th:block>
						</select></td>
						<td><label for="empId">å“¡å·¥IDï¼ˆèº«åˆ†è­‰ï¼‰ï¼š</label></td>
						<td><input type="text" id="empId" name="empId"
							pattern="[A-Z][12][0-9]{8}" maxlength="10" required
							title="è«‹è¼¸å…¥æ­£ç¢ºçš„èº«åˆ†è­‰æ ¼å¼ï¼Œä¾‹å¦‚ A123456789" oninput="checkEmpId(this)">
							<div id="empIdError" class="error-message" style="display: none;">èº«åˆ†è­‰æ ¼å¼ä¸æ­£ç¢ºï¼Œç¯„ä¾‹:A123456789
							</div></td>
					</tr>
					<tr>
						<td><label for="email">E-MAILï¼š</label></td>
						<td><input type="email" id="email" name="email" required
							pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
							title="è«‹è¼¸å…¥æ­£ç¢ºçš„ Email æ ¼å¼ï¼Œä¾‹å¦‚ example@mail.com"
							oninput="checkEmail(this)"> <span id="emailError"
							class="error-message" style="display: none;">Email
								æ ¼å¼ä¸æ­£ç¢ºï¼Œç¯„ä¾‹: example@mail.com</span></td>
						<td><label for="assignStop">æ˜¯å¦åœæ´¾ï¼š</label></td>
						<td><select id="assignStop" name="assignStop">
								<option value="" disabled selected class="placeholder">è«‹é¸æ“‡</option>
								<option value="Y">æ˜¯</option>
								<option value="N">å¦</option>
						</select></td>
					</tr>
					<tr>
						<td><label for="l2aEmpno">è¦†å¯©Aé€ä»¶ä¸»ç®¡ï¼š</label></td>
						<td><select id="l2aEmpno" name="l2aEmpno">
								<option value="" disabled selected class="placeholder">è«‹é¸æ“‡</option>
								<th:block th:if="${dropList1 != null}"
									th:each="emp : ${dropList1}">
									<option th:value="${emp.empNo}" th:text="${emp.empName}"></option>
								</th:block>
						</select></td>
						<td><label for="l2bEmpno">è¦†å¯©Bé€ä»¶ä¸»ç®¡ï¼š</label></td>
						<td><select id="l2bEmpno" name="l2bEmpno">
								<option value="" disabled selected class="placeholder">è«‹é¸æ“‡</option>
								<th:block th:if="${dropList2 != null}"
									th:each="emp : ${dropList2}">
									<option th:value="${emp.empNo}" th:text="${emp.empName}"></option>
								</th:block>
						</select></td>
					</tr>
					<tr>
						<td><label for="groupLevel">æ´¾ä»¶å±¤ç´šï¼š</label></td>
						<td><select id="groupLevel" name="groupLevel">
								<option value="" disabled selected class="placeholder">è«‹é¸æ“‡</option>
								<th:block th:if="${codeGroupLevelDropList != null}"
									th:each="item : ${codeGroupLevelDropList}">
									<option th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
								</th:block>
						</select></td>
					</tr>
				</tbody>
			</table>
		</form>
	</div>
	<div class="modal fade" id="roleDetailModal" tabindex="-1"
		aria-labelledby="roleDetailModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div id="roleDetailContent">
					<!-- ç”¨ JavaScript å¡«å…¥å…§å®¹ -->
				</div>
			</div>
		</div>
	</div>
	<br>
	<br>
	<hr>
	<table>
		<thead>
			<tr>
				<th></th>
				<th>å“¡å·¥ç·¨è™Ÿ (EMP_NO)</th>
				<th>å“¡å·¥å§“å (EMP_NAME)</th>
				<th>å“¡å·¥ID (EMP_ID)</th>
				<th>æ˜¯å¦åœ¨è· (ON_JOB)</th>
				<th>E-MAIL (EMAIL)</th>
				<th>æ˜¯å¦åœæ´¾ (ASSIGN_STOP)</th>
				<th>è¦†å¯©Aé€ä»¶ä¸»ç®¡ (L2A_EMPNO)</th>
				<th>è¦†å¯©Bé€ä»¶ä¸»ç®¡ (L2B_EMPNO)</th>
				<th>æ´¾ä»¶å±¤ç´š (GROUP_LEVEL)</th>
				<th>è§’è‰² (ROLE_NO)</th>
			</tr>
		</thead>
		<tbody>
			<tr th:each="employee : ${employeeList}">
				<td>
					<button type="button"
						th:attr="onclick=|editData('${employee.empNo}', '${employee.empName}', '${employee.onJob}', '${employee.empId}', '${employee.email}', '${employee.assignStop}', '${employee.l2aEmpno}', '${employee.l2bEmpno}', '${employee.groupLevel}','${employee.roleNo}')|">ç·¨è¼¯</button>
					<button type="button" class="btn btn-outline-primary btn-sm"
						th:data-emp-no="${employee.empNo}"
						onclick="openRoleDetailModal(this)">è¨­å®šè§’è‰²</button>
				</td>
				<td th:text="${employee.empNo}">å“¡å·¥ç·¨è™Ÿ</td>
				<td th:text="${employee.empName}">å“¡å·¥å§“å</td>
				<td th:text="${employee.empId}">å“¡å·¥ID</td>
				<td th:text="${employee.onJob}">æ˜¯å¦åœ¨è·</td>
				<td th:text="${employee.email}">E-MAIL</td>
				<td th:text="${employee.assignStop}">æ˜¯å¦åœæ´¾</td>
				<td th:text="${employee.l2aEmpno}">è¦†å¯©Aé€ä»¶ä¸»ç®¡</td>
				<td th:text="${employee.l2bEmpno}">è¦†å¯©Bé€ä»¶ä¸»ç®¡</td>
				<td th:text="${employee.groupLevel}">æ´¾ä»¶å±¤ç´š</td>
				<td th:text="${employee.roleNo}">è§’è‰²</td>
			</tr>
			<tr th:if="${#lists.isEmpty(employeeList)}">
				<td colspan="11" style="text-align: center;">å°šæœªæŸ¥è©¢æˆ–æŸ¥ç„¡è³‡æ–™</td>
			</tr>
		</tbody>
	</table>


<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script>
		function handleButtonClick(action) {
			if (action === 'add') {
				// æ–°å¢æ“ä½œï¼Œé¡¯ç¤ºæ–°å¢è¡¨å–®ä¸¦æ¸…ç©ºå…§å®¹
				document.getElementById("addFormSection").style.display = "block";
				document.getElementById("queryDataBtn").disabled = true;
				document.getElementById("empNo").readonly = false; // å•Ÿç”¨ empNo è¼¸å…¥æ¡†
			} else if (action === 'saveData') {
				alert("å„²å­˜è³‡æ–™");
				document.getElementById("addForm").submit();
				clearAddForm();
				document.getElementById("queryDataBtn").disabled = false;
			} else if (action === 'queryData') {
				alert("æŸ¥è©¢è³‡æ–™");
			}
		}

		function clearAddForm() {
			document.getElementById("addForm").reset();
			document.getElementById("addFormSection").style.display = "none";
			document.getElementById("queryDataBtn").disabled = false;
		}

		// å“¡å·¥idé©—è­‰
		function checkEmpId(input) {
			const errorMsg = document.getElementById('empIdError');
			errorMsg.style.display = input.validity.valid ? 'none' : 'block';
		}

		// Emailé©—è­‰
		function checkEmail(input) {
			const errorMsg = document.getElementById('emailError');
			errorMsg.style.display = input.validity.valid ? 'none' : 'block';
		}

		// å“¡å·¥ç·¨è™Ÿé©—è­‰
		function checkEmpNo(input) {
			const errorMsg = document.getElementById('empNoError');
			errorMsg.style.display = input.validity.valid ? 'none' : 'inline';
		}

		// å“¡å·¥å§“åé©—è­‰
		function checkEmpName(input) {
			const errorMsg = document.getElementById('empNameError');
			errorMsg.style.display = input.validity.valid ? 'none' : 'inline';
		}

		function editData(empNo, empName, onJob, empId, email, assignStop,
				l2aEmpno, l2bEmpno, groupLevel) {
			document.getElementById("addFormSection").style.display = "block";
			document.getElementById("empNo").value = empNo;
			document.getElementById("empNo").readonly = true; // ç·¨è¼¯æ™‚ä¸å¯æ”¹ç·¨è™Ÿ
			document.getElementById("empName").value = empName;
			document.getElementById("onJob").value = onJob;
			document.getElementById("empId").value = empId;
			document.getElementById("email").value = email;
			document.getElementById("assignStop").value = assignStop;
			document.getElementById("l2aEmpno").value = l2aEmpno;
			document.getElementById("l2bEmpno").value = l2bEmpno;
			document.getElementById("groupLevel").value = groupLevel;

			// å¦‚æœä½ éœ€è¦é¡¯ç¤º roleNoï¼Œå¯ä»¥é¡å¤–æ–°å¢æ¬„ä½è™•ç†

			document.getElementById("queryDataBtn").disabled = true;

		}
		// å½ˆå‡ºè§’è‰²è©³ç´°è¦–çª—
		function openRoleDetailModal(button) {
			const empNo = button.getAttribute('data-emp-no');
	
			fetch(`/EmployeeSet/roleDetail?empNo=${empNo}`)
				.then(response => response.text())
				.then(html => {
					document.getElementById("roleDetailContent").innerHTML = html;
			const modal = new bootstrap.Modal(document.getElementById("roleDetailModal"));
				modal.show();
				console.log("modal", modal);
			})
				.catch(error => {
					console.error("è¼‰å…¥è§’è‰²è©³ç´°è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
				});
		}
		
		function closeRoleForm() {
			document.getElementById("roleFormModal").style.display = "none"; // é—œé–‰ modal
		}

		function clearAddForm() {
			document.getElementById("addForm").reset();
			document.getElementById("addFormSection").style.display = "none";
			document.getElementById("queryDataBtn").disabled = false;
		}

		// é€å‡ºå“¡å·¥è³‡æ–™
		$('#addFormSection').on('submit', function(event) {
			event.preventDefault(); // é˜²æ­¢è¡¨å–®æäº¤

			var formData = $(this).serialize(); // åºåˆ—åŒ–è¡¨å–®è³‡æ–™

			$.ajax({
				url : '/EmployeeSet/save',
				type : 'POST',
				data : formData,
				success : function(response) {
					// æˆåŠŸå¾Œçš„è™•ç†
					alert(response); // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
					// ä½ å¯ä»¥é¸æ“‡éš±è—è¡¨å–®ã€æ¸…ç©ºè¡¨å–®æˆ–æ›´æ–°é é¢
					// ä¾‹å¦‚ï¼šwindow.location.href = '/EmployeeSet'; // è·³è½‰é é¢
				},
				error : function(xhr, status, error) {
					// éŒ¯èª¤è™•ç†
					alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦: ' + xhr.responseText);
				}
			});
		});
		
		<!-- å¯«åœ¨ä¸»é é¢ -->
		$(document).on('click', '#btnAddRole', function () {
		    console.log('å„²å­˜è³‡æ–™æŒ‰éˆ•è¢«é»æ“Š');
		    const selectedRole = $('input[name="selectedRole"]:checked').val();
		    const empNo = $('#hiddenEmpNo').val();

		    if (!selectedRole) {
		        alert("è«‹å…ˆé¸æ“‡ä¸€å€‹è§’è‰²");
		        return;
		    }

		    const formData = {
		        empNo: empNo,
		        roleNo: selectedRole
		    };

		    $.ajax({
		        url: '/EmployeeSet/role/save',
		        type: 'POST',
		        data: formData,
		        contentType: 'application/x-www-form-urlencoded',
		        dataType: 'json',
		        success: function (response) {
		            alert(response.message);
		            let modal = bootstrap.Modal.getInstance(modalElement);
		            if (!modal) {
		                modal = new bootstrap.Modal(modalElement);
		            }
		            modal.hide();
		        },
		        error: function (xhr) {
		            alert('å„²å­˜å¤±æ•—: ' + xhr.responseText);
		        }
		    });
		});

	</script>
	
</body>
</html>
