<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>建檔作業</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link rel="stylesheet" th:href="@{/css/CreateJob.css}" />
</head>
<body>
	<div class="button-container">
		<button id="addDataBtn" type="button" class="btn btn-primary"
			onclick="addButtonClick('addData')">新建案件</button>
		<button id="saveData" type="button" class="btn btn-primary"
			onclick="saveFormData()">送出</button>
	</div>
	<br>
	<form id="addForm" action="/CreateJob" method="get">
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="applno-label">收件編號</span> <input
						type="text" class="form-control" id="applno" name="applno"
						aria-describedby="applno-label">
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuName-label">中文姓名</span> <input
						type="text" class="form-control" id="cuName" name="cuName"
						aria-describedby="cuName-label">
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuId-label">身分證字號</span> <input
						type="text" class="form-control" id="cuId" name="cuId"
						aria-describedby="cuId-label">
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuName">生日</span> <input
						type="date" class="form-control" id="cuBirthday" name="cuBirthday" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuName">帳單地址</span>
					<select id="citySelect1" name="city" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
						<th:block th:each="item : ${cityDtoList}">
							<option th:value="${item.fkNo}" th:data-zip-no="${item.zipNo}"
								th:text="${item.zipName}"></option>
						</th:block>
					</select> <select id="districtSelect1" name="district" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
					</select> <input type="text" id="cuBillAddr" name="cuBillAddr"
						class="form-control" placeholder="請輸入"
						style="flex: 0 0 70%; max-width: 70%;" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="applno-label">住宅電話</span> <input
						type="text" class="form-control" id="cuHTel" name="cuHTel" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuCpTel-label">公司電話</span> <input
						type="text" id="cuCpTel" name="cuCpTel" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuMTel-label">行動電話</span> <input
						type="text" id="cuMTel" name="cuMTel" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuEmail-label">@</span> <input
						type="email" id="cuEmail" name="cuEmail" class="form-control" />
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cuCpName-label">公司名稱</span> <input
						type="text" id="cuCpName" name="cuCpName" class="form-control" />
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cardFlag-label">卡片 flag</span> <select
						id="cardFlag" name="cardFlag" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${cardFlagDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="fraudType-label">詐欺類型</span> <select
						id="fraudType" name="fraudType" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${fraudTypeDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="cardType-label">卡別</span> <select
						id="cardType" name="cardType" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${cardTypeDtoList}"
							th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="agreeChange-label">是否同意改發</span>
					<select id="agreeChange" name="agreeChange" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${yNDtoList}" th:value="${item.codeNo}"
							th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
			<div class="col-md-3">
				<div class="input-group">
					<span class="input-group-text" id="agreePrint-label">是否列印通知函</span>
					<select id="agreePrint" name="agreePrint" class="form-select">
						<option value="">請選擇</option>
						<option th:each="item : ${yNDtoList}" th:value="${item.codeNo}"
							th:text="${item.codeDesc}"></option>
					</select>
				</div>
			</div>
		</div>
		<div class="row mb-3">
			<div class="col-md-12">
				<div class="input-group">
					<span class="input-group-text" id="basic-addon-cuSendCode">通知函寄送地址</span>

					<!-- 縣市 -->
					<select id="citySelect2" name="city" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
						<th:block th:each="item : ${cityDtoList}">
							<option th:value="${item.fkNo}" th:data-zip-no="${item.zipNo}"
								th:text="${item.zipName}"></option>
						</th:block>
					</select>

					<!-- 鄉鎮 -->
					<select id="districtSelect2" name="district" class="form-select"
						style="flex: 0 0 10%; max-width: 10%;">
						<option value="">請選擇</option>
					</select>

					<!-- 詳細地址 -->
					<input type="text" id="cuSendCode" name="cuSendCode"
						class="form-control" placeholder="請輸入"
						style="flex: 0 0 65%; max-width: 65%;" />
				</div>
			</div>
		</div>
	</form>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
    $(document).ready(function () {
        function bindCityChange(citySelectId, districtSelectId) {
            $('#' + citySelectId).change(function () {
                var selectedZipNo = $(this).find('option:selected').data('zip-no');

                console.log('Selected zipNo:', selectedZipNo);

                if (!selectedZipNo) {
                    console.warn('No value selected');
                    return;
                }

                $.ajax({
                    url: '/getDistricts',
                    type: 'GET',
                    data: { zipNo: selectedZipNo },
                    success: function (districts) {
                        console.log('Returned districts:', districts);
                        var $districtSelect = $('#' + districtSelectId);
                        $districtSelect.empty().append('<option value="">請選擇</option>');

                        if (Array.isArray(districts)) {
                            $.each(districts, function (index, district) {
                                if (district.fkNo && district.zipName) {
                                    $districtSelect.append(
                                        '<option value="' + district.fkNo + '">' + district.zipName + '</option>'
                                    );
                                }
                            });
                        } else {
                            console.error('Returned districts is not an array:', districts);
                        }
                    },
                    error: function () {
                        alert('無法取得區域資料，請稍後再試');
                    }
                });
            });
        }

        // ⚠️ ID 要與 HTML 完全一致（區分大小寫）
        bindCityChange('citySelect1', 'districtSelect1');
        bindCityChange('citySelect2', 'districtSelect2');
    });
    
    // 新增表單
	function saveFormData() {
	    const fields = [
	    	'applno', 'cuName', 'cuId', 'cuBirthday', 'cuBillAddr',
	        'citySelect1', 'districtSelect1', 'cuHTel', 'cuCpTel', 'cuMTel',
	        'cuEmail', 'cuCpName', 'cardFlag', 'fraudType', 'cardType',
	        'agreeChange', 'agreePrint', 'cuSendCode', 'citySelect2', 'districtSelect2'
	    ];
	
	    const formData = {};
	
	    fields.forEach(field => {
	        const el = document.getElementById(field);
	        if (el) {
	            let val = el.value?.trim() ?? null;
	
	            // 🔧 特別處理 cuBirthday 格式（yyyy-MM-dd → yyyyMMdd）
	            if (field === 'cuBirthday' && val) {
	                val = val.replace(/-/g, '');  // 移除 "-"
	                if (val.length !== 8) {
	                    alert('生日格式錯誤，請輸入正確日期');
	                    return;
	                }
	            }
	
	            formData[field] = val;
	        } else {
	            formData[field] = null;
	            console.warn(`找不到欄位: ${field}`);
	        }
	    });
	
	    console.log('✅ 最終送出資料:', formData);
	
	   $.ajax({
	        url: '/CreateJob/save',
	        type: 'POST',
	        contentType: 'application/json',
	        data: JSON.stringify(formData),
	        success: function (response) {
	            alert(response);
	        },
	        error: function (xhr) {
	            alert('儲存失敗: ' + xhr.responseText);
	        }
	    });
	}
</script>
</body>
</html>