<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>æ¡ˆä»¶æ¸…å–®æ˜ç´°</title>
<link rel="stylesheet" href="/css/Review.css" />
</head>
<body>
	<div id="saveFormSection" style="margin-top: 20px;">
		<form id="addForm" action="/CreateJob" method="get">
			<table>
				<tbody>
					<tr>
						<td class="label-cell"><label for="applno">æ”¶ä»¶ç·¨è™Ÿï¼š</label></td>
						<td><input id="applno" name="applno" readonly><span></span></td>
						<td class="label-cell"><label for="cuName">ä¸­æ–‡å§“åï¼š</label></td>
						<td><input id="cuName" name="cuName"><span></span></td>
						<td class="label-cell"><label for="cuId">èº«åˆ†è­‰å­—è™Ÿï¼š</label></td>
						<td><input id="cuId" name="cuId"><span></span></td>
					</tr>
					<tr>
						<td class="label-cell"><label for="cuBirthday">ç”Ÿæ—¥ ï¼š</label></td>
						<td><input type="date" id="cuBirthday" name="cuBirthday"><span></span>
						</td>
						<td class="label-cell"><label for="cuBillAddr">å¸³å–®åœ°å€ ï¼š</label></td>
						<td colspan="5">
							<!-- åŸå¸‚ä¸‹æ‹‰é¸å–® --> <select id="citySelect1" name="city">
								<option value="">è«‹é¸æ“‡</option>
								<th:block th:each="item : ${cityDtoList}">
									<option th:value="${item.fkNo}" th:data-zip-no="${item.zipNo}"
										th:text="${item.zipName}"></option>
								</th:block>
						</select> <!-- å€åŸŸä¸‹æ‹‰é¸å–® --> <select id="districtSelect1" name="district">
								<option value="">è«‹é¸æ“‡</option>
								<!-- é è¨­çš„å€åŸŸè³‡æ–™ï¼Œå°‡æœƒåœ¨åŸå¸‚æ”¹è®Šå¾Œé€šéAJAXæ›´æ–° -->
						</select> <!-- å…¶ä»–å¸³å–®åœ°å€æ¬„ä½ --> <input type="text" id="cuBillAddr"
							name="cuBillAddr" placeholder="è«‹è¼¸å…¥" style="width: 40%;">
							<span></span>
						</td>
					</tr>
					<tr>
						<td class="label-cell"><label for="cuHTel">ä½å®…é›»è©±ï¼š</label></td>
						<td><input id="cuHTel" name="cuHTel"><span></span></td>
						<td class="label-cell"><label for="cuCpTel">å…¬å¸é›»è©±ï¼š</label></td>
						<td><input id="cuCpTel" name="cuCpTel"><span></span></td>
						<td class="label-cell"><label for="cuMTel">è¡Œå‹•é›»è©±ï¼š</label></td>
						<td><input id="cuMTel" name="cuMTel"><span></span></td>
					</tr>
					<tr>
						<td class="label-cell"><label for="cuEmail">emailï¼š</label></td>
						<td><input id="cuEmail" name="cuEmail"><span></span></td>
						<td class="label-cell"><label for="cuCpName">å…¬å¸åç¨±ï¼š</label></td>
						<td><input id="cuCpName" name="cuCpName"><span></span></td>
						<td class="label-cell"><label for="cardFlag">å¡ç‰‡ flagï¼š</label></td>
						<td><select id="cardFlag" name="cardFlag">
								<option value="">è«‹é¸æ“‡</option>
								<option th:each="item : ${cardFlagDtoList}"
									th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
						</select> <span></span></td>
					</tr>
					<tr>
						<td class="label-cell"><label for="fraudType">è©æ¬ºé¡å‹ï¼š</label></td>
						<td><select id="fraudType" name="fraudType">
								<option value="">è«‹é¸æ“‡</option>
								<option th:each="item : ${fraudTypeDtoList}"
									th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
						</select><span></span></td>

						<td class="label-cell"><label for="cardType">å¡åˆ¥ï¼š</label></td>
						<td><select id="cardType" name="cardType">
								<option value="">è«‹é¸æ“‡</option>
								<option th:each="item : ${cardTypeDtoList}"
									th:value="${item.codeNo}" th:text="${item.codeDesc}"></option>
						</select><span></span></td>
						<td class="label-cell"><label for="agreeChange">æ˜¯å¦åŒæ„æ”¹ç™¼ï¼š</label></td>
						<td><select id="agreeChange" name="agreeChange">
								<option value="">è«‹é¸æ“‡</option>
								<option th:each="item : ${yNDtoList}" th:value="${item.codeNo}"
									th:text="${item.codeDesc}"></option>
						</select><span></span></td>
					</tr>
					<tr>
						<td class="label-cell"><label for="agreePrint">æ˜¯å¦åˆ—å°é€šçŸ¥å‡½ï¼š</label></td>
						<td><select id="agreePrint" name="agreePrint">
								<option value="">è«‹é¸æ“‡</option>
								<option th:each="item : ${yNDtoList}" th:value="${item.codeNo}"
									th:text="${item.codeDesc}"></option>
						</select><span></span></td>
						<td class="label-cell"><label for="cuSendCode">é€šçŸ¥å‡½å¯„é€åœ°å€ï¼š</label></td>
						<td colspan="5">
							<!-- åŸå¸‚ä¸‹æ‹‰é¸å–® --> <select id="citySelect2" name="city">
								<option value="">è«‹é¸æ“‡</option>
								<th:block th:each="item : ${cityDtoList}">
									<option th:value="${item.fkNo}" th:data-zip-no="${item.zipNo}"
										th:text="${item.zipName}"></option>
								</th:block>
						</select> <!-- å€åŸŸä¸‹æ‹‰é¸å–® --> <select id="districtSelect2" name="district">
								<option value="">è«‹é¸æ“‡</option>
								<!-- é è¨­çš„å€åŸŸè³‡æ–™ï¼Œå°‡æœƒåœ¨åŸå¸‚æ”¹è®Šå¾Œé€šéAJAXæ›´æ–° -->
						</select> <!-- å…¶ä»–å¸³å–®åœ°å€æ¬„ä½ --> <input type="text" id="cuSendCode"
							name="cuSendCode" placeholder="è«‹è¼¸å…¥" style="width: 40%;">
							<span></span>
						</td>
					</tr>
					<tr>
						<td class="label-cell"><label for="cuBillDate">å¸³å–®çµå¸³æ—¥ï¼š</label></td>
						<td><input type="date" id="cuBillDate" name="cuBillDate"><span></span></td>
						<td class="label-cell"><label for="loanCount">æˆæ¬¾ç­†æ•¸ï¼š</label></td>
						<td><input id="loanCount" name="loanCount"><span></span></td>
						<td class="label-cell"><label for="loanAmount">æˆæ¬¾é‡‘é¡ï¼š</label></td>
						<td><input id="loanAmount" name="loanAmount"><span></span></td>
					</tr>
					<tr>
						<td class="label-cell"><label for="claimCount">è«‹æ¬¾ç­†æ•¸ï¼š</label></td>
						<td><input id="claimCount" name="claimCount"><span></span></td>
						<td class="label-cell"><label for="claimAmount">è«‹æ¬¾é‡‘é¡ï¼š</label></td>
    					<td><input id="claimAmount" name="claimAmount"><span></span></td>
    					<td class="label-cell"><label for="cbSuccessAmount">CBæˆåŠŸé‡‘é¡ï¼š</label></td>
    					<td><input id="cbSuccessAmount" name="cbSuccessAmount"><span></span></td>
					</tr>
					<tr>
					    <td class="label-cell"><label for="customerPayAmount">å®¢æˆ¶æ‰¿æ“”é‡‘é¡ï¼š</label></td>
					    <td><input id="customerPayAmount" name="customerPayAmount"><span></span></td>
					    <td class="label-cell"><label for="bankPayAmount">æœ¬è¡Œæ‰¿æ“”é‡‘é¡ï¼š</label></td>
    					<td><input id="bankPayAmount" name="bankPayAmount"><span></span></td>
					</tr>
					<tr>
					    <td class="label-cell"><label for="fscComplaint">é‡‘ç®¡æœƒç”³è¨´ï¼š</label></td>
					    <td><input id="fscComplaint" name="fscComplaint"><span></span></td>
    					<td class="label-cell"><label for="finDispute">é‡‘èè©•è­°ä¸­å¿ƒç”³è¨´ï¼š</label></td>
    					<td><input id="finDispute" name="finDispute"><span></span></td>
    					<td class="label-cell"><label for="judicialAgency">å¸æ³•æ©Ÿé—œä¾†å‡½æŸ¥è©¢-æ©Ÿé—œåç¨±ï¼š</label></td>
    					<td><input id="judicialAgency" name="judicialAgency"><span></span></td>
					</tr>
					<tr>
					    <td class="label-cell"><label for="fscDisputeDate">é‡‘ç®¡æœƒç”³è¨´æ—¥æœŸï¼š</label></td>
					    <td><input type= date id="fscDisputeDate" name="fscDisputeDate"><span></span></td>
					    <td class="label-cell"><label for="finDisputeDate">é‡‘èè©•è­°ä¸­å¿ƒç”³è¨´æ—¥æœŸï¼š</label></td>
    					<td><input type= date id="finDisputeDate" name="finDisputeDate"><span></span></td>
    					<td class="label-cell"><label for="judicialDate">å¸æ³•æ©Ÿé—œä¾†å‡½æŸ¥è©¢æ—¥æœŸï¼š</label></td>
    					<td><input type= date id="judicialDate" name="judicialDate"><span></span></td>
					</tr>
					<tr>
					    <td class="label-cell"><label for="suspectName">å«ŒçŠ¯å§“åï¼š</label></td>
					    <td><input id="suspectName" name="suspectName"><span></span></td>
					    <td class="label-cell"><label for="suspectId">å«ŒçŠ¯IDï¼š</label></td>
   			 			<td><input id="suspectId" name="suspectId"><span></span></td>
   			 			<td class="label-cell"><label for="fraudFeature">ç›œåˆ·ç‰¹å¾µï¼š</label></td>
					</tr>
				</tbody>
			</table>
		</form>
	</div>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
	const urlParams = new URLSearchParams(window.location.search);
    const applno = urlParams.get('applno');
    const applnoInput = document.getElementById('applno');
    if (applnoInput && applno !== null) {
        applnoInput.value = applno;  // å° input å…ƒç´ è¦ç”¨ value å±¬æ€§
    } else {
        console.warn('æ‰¾ä¸åˆ° applno è¼¸å…¥æ¡†æˆ– URL æ²’å¸¶ applno');
    }

    $(document).ready(function () {
        function bindCityChange(citySelectId, districtSelectId) {
            $('#' + citySelectId).change(function () {
                var selectedZipNo = $(this).find('option:selected').data('zip-no');

                console.log('Selected zipNo:', selectedZipNo);

                if (!selectedZipNo) {
                    console.warn('No value selected');
                    return;
                }

                $.ajax({
                    url: '/getDistricts',
                    type: 'GET',
                    data: { zipNo: selectedZipNo },
                    success: function (districts) {
                        console.log('Returned districts:', districts);
                        var $districtSelect = $('#' + districtSelectId);
                        $districtSelect.empty().append('<option value="">è«‹é¸æ“‡</option>');

                        if (Array.isArray(districts)) {
                            $.each(districts, function (index, district) {
                                if (district.fkNo && district.zipName) {
                                    $districtSelect.append(
                                        $('<option>').val(district.fkNo).text(district.zipName)
                                    );
                                }
                            });
                        } else {
                            console.error('Returned districts is not an array:', districts);
                            alert('è³‡æ–™æ ¼å¼ç•°å¸¸ï¼Œè«‹é€šçŸ¥ç³»çµ±ç®¡ç†å“¡');
                        }
                    },
                    error: function () {
                        alert('ç„¡æ³•å–å¾—å€åŸŸè³‡æ–™ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                });
            });
        }

        // ç¶å®šåŸå¸‚èˆ‡å€åŸŸä¸‹æ‹‰é¸å–®
        bindCityChange('citySelect1', 'districtSelect1');
        bindCityChange('citySelect2', 'districtSelect2');
    });
    
    // æ–°å¢è¡¨å–®
function saveFormData() {
    const fields = [
    	'applno', 'cuName', 'cuId', 'cuBirthday', 'cuBillAddr',
        'citySelect1', 'districtSelect1', 'cuHTel', 'cuCpTel', 'cuMTel',
        'cuEmail', 'cuCpName', 'cardFlag', 'fraudType', 'cardType',
        'agreeChange', 'agreePrint', 'cuSendCode', 'citySelect2', 'districtSelect2'
    ];

    const formData = {};

    fields.forEach(field => {
        const el = document.getElementById(field);
        if (el) {
            let val = el.value?.trim() ?? null;
            // ğŸ”§ ç‰¹åˆ¥è™•ç† cuBirthday æ ¼å¼ï¼ˆyyyy-MM-dd â†’ yyyyMMddï¼‰
            if (field === 'cuBirthday' && val) {
                val = val.replace(/-/g, '');  // ç§»é™¤ "-"
                if (val.length !== 8) {
                    alert('ç”Ÿæ—¥æ ¼å¼éŒ¯èª¤ï¼Œè«‹è¼¸å…¥æ­£ç¢ºæ—¥æœŸ');
                    return;
                }
            }
            formData[field] = val;
        } else {
            formData[field] = null;
            console.warn(`æ‰¾ä¸åˆ°æ¬„ä½: ${field}`);
        }
    });

    console.log('âœ… æœ€çµ‚é€å‡ºè³‡æ–™:', formData);

   $.ajax({
        url: '/CreateJob/save',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
            alert(response);
        },
        error: function (xhr) {
            alert('å„²å­˜å¤±æ•—: ' + xhr.responseText);
        }
    });
}
</script>
</body>
</html>